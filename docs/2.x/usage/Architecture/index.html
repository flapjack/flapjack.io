<!DOCTYPE html>
<html lang="en">
    <head>
  <title>Flapjack, monitoring notification routing + event processing</title>
  <link rel="stylesheet" href="/stylesheets/bootstrap.min.css"/>
  <link rel="stylesheet" href="/stylesheets/api-screen.css" type="text/css" media="screen" />
  <link rel="stylesheet" href="/stylesheets/api-syntax.css" type="text/css" media="screen" />
  <link rel="stylesheet" href="/stylesheets/github-markdown.css" type="text/css">
  <link rel="shortcut icon" href="/images/flapjack-2013-favicon-64-32-24-16.ico" />
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    .markdown-body {
        min-width: 200px;
        max-width: 790px;
        margin: 0 auto;
        padding: 30px;
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-default navbar-inverse" role="navigation" style="margin-bottom: 0px">
    <div class="container-fluid" id="navfluid">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navigationbar">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="/">
          <img class="logo" src="/images/flapjack-2013-notext-transparent-300-300.png"/>
          <span class="name">Flapjack</span>
        </a>
      </div>
      <div class="collapse navbar-collapse" id="navigationbar">
        <ul class="nav navbar-nav navbar-right">
          <li><a href="/docs/1.0/usage/quickstart">Quickstart</a></li>
          <li><a href="/docs">Documentation</a></li>
          <li><a href="/support">Support</a></li>
        </ul>
      </div><!-- /.navbar-collapse -->
    </div><!-- /.container-fluid -->
  </nav>

    <center>
        <div class="alert alert-info" style="padding-top: 10px; padding-bottom: 0px; margin-bottom: 0px; height: 40px">
    <strong>This is documentation for Flapjack version 2.x:</strong>
    If you're looking for version 1.0 documentation, click <a class="alert-link" href="http://flapjack.io/docs/1.0">here.</a>
  </div>

    </center>
    <div class="container content">
      <div class="row">
        <div class="col-md-offset-1 col-md-10 markdown-body">
        <h2 id='contents'>Contents</h2>
<ul>
<li><a href="#architecture">Architecture</a></li>
<li><a href="#components">Components</a></li>
<li><a href="#redis_database_instances">Redis Database Instances</a></li>
</ul>

<p><a id="architecture">&nbsp;</a></p>
<h2 id='architecture'>Architecture</h2>
<p><img alt="Flapjack architecture diagram as of 2013-09-27" src="../../../../images/architecture.png" /></p>
<pre><code class="highlight plaintext">Check Receivers ---&gt; Executive ---&gt; Gateways
</code></pre>

<p><strong>Check Receivers</strong> read check data generated by external programs; Flapjack ships with a Nagios checks receiver, and connectors to other sources of check data could also be written. Checks define the entity they refer to as being in one of three states (<code class="prettyprint">OK</code>, <code class="prettyprint">WARNING</code> or <code class="prettyprint">CRITICAL</code>), are timestamped and can optionally include further data about the reason for the current entity state. The checks are added onto an events queue by the check receivers.</p>

<p>The Flapjack <strong>Executive</strong> reads events from the events queue and determines which contacts should be notified for them. It runs filters to prevent notifications being fired too often for the same check.</p>

<p>Flapjack <strong>Gateways</strong> serve as the public interface to Flapjack. There are <em>unidirectional</em> notifiers (e.g. <code class="prettyprint">email</code> and <code class="prettyprint">sms</code>, which read notifications from a queue and send them out to registered contacts, there are <em>bidirectional</em> notifiers (e.g. <code class="prettyprint">jabber</code>, <code class="prettyprint">pagerduty</code>) which do the above and also offer a back-channel for acknowledgements etc., and there are also <code class="prettyprint">web</code> and <code class="prettyprint">api</code> gateways for retrieving reporting data, creating maintenance periods, acknowledging checks, etc.</p>
<h3 id='processor-and-notifier'>Processor and Notifier</h3>
<p>In the beginning, there was Executive. This has been split into two separate components, <em>processor</em> and <em>notifier</em>.</p>

<p>Flapjack processor processes events from the <em>events</em> list in redis. It does a blocking read on redis so new events are picked off the events list and processed as soon as they created.</p>

<p>When executive decides somebody ought to be notified (for a problem, recovery, or acknowledgement or what-have-you) it generates a job on the <em>notifications</em> queue.</p>

<p>Notifier picks up jobs from the <em>notifications</em> queue, looks up contact information, applies notification rules and per-media intervals and rollup logic, and then creates notification jobs for the appropriate notification gateways.</p>

<p><a id="components">&nbsp;</a></p>
<h2 id='components'>Components</h2>
<p>Executables:</p>

<ul>
<li><code class="prettyprint">flapjack</code> =&gt; starts multiple components (&lsquo;pikelets&rsquo;) within the one ruby process as specified in the configuration file.</li>
<li><code class="prettyprint">flapjack receiver nagios</code> =&gt; reads nagios check output on standard input and places them on the events queue in redis as JSON blobs.</li>
<li><code class="prettyprint">flapjack receiver nsca</code> =&gt; reads the nagios&#39; commandfile output and places them on the events queue in redis as JSON blobs.</li>
<li><code class="prettyprint">flapjack flapper</code> =&gt; runs a daemon that intermittently listens on port 12345 (one minute on, one minute off, &hellip;)
to be used for generating heartbeat events for end to end monitoring of flapjack</li>
<li><code class="prettyprint">flapjack simulate fail</code> =&gt; simulates a failed check by creating a stream of events for flapjack to process</li>
</ul>

<p>Pikelets:</p>

<ul>
<li>  <code class="prettyprint">processor</code> =&gt; processes monitoring events off the <em>events</em> queue (a redis list) and decides what actions to take (generate notification event, record state changes, etc)</li>
<li><p><code class="prettyprint">notifier</code> =&gt; processes notification events off the <em>notifications</em> queue (a redis list) and works out who to notify, and on which media, and with what kind of notification message. It then creates jobs for the various notification gateways (below)</p></li>
<li><p>notification gateways</p>

<ul>
<li><code class="prettyprint">aws_sns</code></li>
<li><code class="prettyprint">email</code> =&gt; generates email notifications (mail)</li>
<li><code class="prettyprint">jabber</code> =&gt; connects to an XMPP (jabber) server, sends notifications (to rooms and individuals), handles acknowledgements from jabber users and other commands (xmpp4r)</li>
<li><code class="prettyprint">pagerduty</code> =&gt; sends notifications to and accepts acknowledgements from <a href="http://www.pagerduty.com/">PagerDuty</a> (NB: contacts will need to have a registered PagerDuty account to use this)</li>
<li><code class="prettyprint">slack</code></li>
<li><code class="prettyprint">sms_aspsms</code> =&gt; generates sms notifications through aspsms.com</li>
<li><code class="prettyprint">sms_messagenet</code> =&gt; generates sms notifications through MessageNet</li>
<li><code class="prettyprint">sms_nexmo</code> =&gt; generates sms notifications through Nexmo</li>
<li><code class="prettyprint">sms_twilio</code> =&gt; generates sms notifications through Twilio</li>
</ul></li>
<li><p>other gateways</p>

<ul>
<li><code class="prettyprint">web</code> =&gt; browsable web interface (sinatra, puma)</li>
<li><code class="prettyprint">jsonapi</code> =&gt; HTTP API server (sinatra, puma)</li>
<li><code class="prettyprint">oobetet</code> =&gt; &ldquo;out-of-band&rdquo; end-to-end testing, used for monitoring other instances of flapjack to ensure that they are running correctly</li>
</ul></li>
</ul>

<p>Pikelets are flapjack components which can be run within the same ruby process, or as separate processes.</p>

<p>The simplest configuration will have one <code class="prettyprint">flapjack</code> process running processor, notifier, web, and some notification gateways.  The same process will also run the receiver, which receives events from Nagios and places them on the events queue for processing.</p>

<p><a id="redis_database_instances">&nbsp;</a></p>
<h2 id='redis-database-instances'>Redis Database Instances</h2>
<p>We use the following redis database numbers by convention:</p>

<ul>
<li>0 =&gt; production</li>
<li>6 =&gt; quickstart</li>
<li>13 =&gt; development</li>
<li>14 =&gt; testing</li>
</ul>

      </div>
    </div>
  </div> <!-- container -->

  <footer>
<div class="row">
<div class="col-md-4 col-md-offset-2">
  Flapjack was conceptualised by
  <a href="https://twitter.com/auxesis">Lindsay Holmwood</a>.
  <a href="https://twitter.com/jessereynolds">Jesse Reynolds</a> and
  <a href="https://github.com/ali-graham">Ali Graham</a>
  are the primary developers.
  View the project on <a href="https://github.com/flapjack/flapjack">GitHub</a>.
</div>
<div class="col-md-4 sponsor">
  <a href="http://bulletproof.net.au" target="_bulletproof">
    <img class="bulletproof" src="/images/bulletproof-logo.png"/>
  </a>
  <span class="bulletproof subtext">
    Development sponsored by
    <a href="http://bulletproof.net.au" target="_bulletproof">Bulletproof</a>.
  </span>
</div>
</div>
</footer>

<script type="text/javascript">
  var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
  document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
  try {
    var pageTracker = _gat._getTracker("UA-388962-5");
    pageTracker._trackPageview();
  } catch(err) {}
</script>

</body>
</html>
