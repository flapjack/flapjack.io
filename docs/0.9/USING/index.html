<!DOCTYPE html>
<html lang="en">
    <head>
  <title>Flapjack, monitoring notification routing + event processing</title>
  <link rel="stylesheet" href="/stylesheets/bootstrap.min.css"/>
  <link rel="stylesheet" href="/stylesheets/api-screen.css" type="text/css" media="screen" />
  <link rel="stylesheet" href="/stylesheets/api-syntax.css" type="text/css" media="screen" />
  <link rel="stylesheet" href="/stylesheets/github-markdown.css" type="text/css">
  <link rel="shortcut icon" href="/images/flapjack-2013-favicon-64-32-24-16.ico" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    .markdown-body {
        min-width: 200px;
        max-width: 790px;
        margin: 0 auto;
        padding: 30px;
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-default navbar-inverse" role="navigation" style="margin-bottom: 0px">
    <div class="navbar-header">
      <a class="navbar-brand" href="/">
        <img class="logo" src="/images/flapjack-2013-notext-transparent-300-300.png"/>
        <span class="name">Flapjack</span>
      </a>
    </div>
    <div class="collapse navbar-collapse navbar-ex1-collapse">
      <ul class="nav navbar-nav navbar-right">
        <li><a href="/docs/1.0/usage/quickstart">Quickstart</a></li>
        <li><a href="/docs">Documentation</a></li>
        <li><a href="/support">Support</a></li>
      </ul>
    </div>
  </nav>

    <center>
        <div class="alert alert-info" style="padding-top: 10px; padding-bottom: 0px; margin-bottom: 0px; height: 40px">
    <strong>This is documentation for Flapjack version 0.9:</strong>
    If you're looking for version 1.0 documentation, click <a class="alert-link" href="http://flapjack.io/docs/1.0">here.</a>
  </div>

    </center>
    <div class="container content">
      <div class="row">
        <div class="col-md-offset-1 col-md-10">
        <h2 id='contents'>Contents</h2>
<ul>
<li><a href="#installing">Installing</a></li>
<li><a href="#dependencies">Dependencies</a></li>
<li><a href="#architecture">Architecture</a></li>
<li><a href="#components">Components</a></li>
<li><a href="#configuring-components">Configuring Components</a></li>
<li><a href="#running">Running</a></li>
<li><a href="#resque">Resque</a></li>
<li><a href="#redis_database_instances">Redis Database Instances</a></li>
</ul>

<p><a id="installing">&nbsp;</a></p>
<h2 id='installing'>Installing</h2>
<p>The recommended platform to run Flapjack on (other than development) is Ubuntu Precise 64 (Ubuntu 12.04, amd64).
We provide a package for this platform on our <a href="http://packages.flapjack.io">package repository</a>.
The package includes all runtime dependencies, so you shouldn&rsquo;t need to install anything else to get flapjack up and running with a vanilla configuration.</p>

<p>Note also, that if you just want to have a quick play with Flapjack, then why not use <a href="https://github.com/flapjack/vagrant-flapjack">vagrant-flapjack</a> as this will also take care of creating and setting up an Ubuntu virtual machine and installing flapjack for you.</p>

<p>To install the package on Ubuntu Precise 64, add the deb repo to your apt sources:</p>
<pre><code class="highlight plaintext">deb http://packages.flapjack.io/deb precise main
</code></pre>

<p>eg:</p>
<pre><code class="highlight shell">cat <span class="sh">&lt;&lt; EOF &gt; /etc/apt/sources.list.d/flapjack.list
deb http://packages.flapjack.io/deb precise main
EOF
</span></code></pre>

<p>Then run:</p>
<pre><code class="highlight plaintext">sudo apt-get update &amp;&amp; sudo apt-get install flapjack
</code></pre>

<p>You should now find that flapjack and redis have started up. Try visiting the <a href="http://localhost:3080">flapjack web interface</a>.</p>
<h2 id='installing-as-a-gem'>Installing as a gem</h2>
<p>If you&rsquo;re determined to run Flapjack on an unsupported platform, you can install the Flapjack ruby gem as follows:</p>
<pre><code class="highlight shell">gem install flapjack
</code></pre>

<p><a id="dependencies">&nbsp;</a></p>
<h3 id='dependencies'>Dependencies</h3>
<p>The Flapjack ruby gem has the following dependencies:</p>

<ul>
<li>Ruby &gt;= 1.9</li>
<li>Redis &gt;= 2.4.15</li>
</ul>

<p>and the following gems:</p>

<ul>
<li><code class="prettyprint">daemons</code></li>
<li><code class="prettyprint">oj</code></li>
<li><code class="prettyprint">redis</code></li>
<li><code class="prettyprint">eventmachine</code> (~&gt; 1.0.0)</li>
<li><code class="prettyprint">hiredis</code></li>
<li><code class="prettyprint">em-synchrony</code> (~&gt; 1.0.2)</li>
<li><code class="prettyprint">em-http-request</code></li>
<li><code class="prettyprint">em-resque</code></li>
<li><code class="prettyprint">sinatra</code></li>
<li><code class="prettyprint">rack-fiber_pool</code></li>
<li><code class="prettyprint">thin</code></li>
<li><code class="prettyprint">mail</code></li>
<li><code class="prettyprint">blather</code></li>
<li><code class="prettyprint">chronic</code></li>
<li><code class="prettyprint">chronic_duration</code></li>
</ul>

<p>You&rsquo;ll need a working C compiler installed for the gems above with binary components (<code class="prettyprint">eventmachine</code>, <code class="prettyprint">oj</code> and <code class="prettyprint">hiredis</code>).</p>

<p>We want to lower the number of gems that Flapjack relies on &ndash; any pull requests will be gratefully received.</p>

<p><a id="architecture">&nbsp;</a></p>
<h2 id='architecture'>Architecture</h2>
<p><img alt="Flapjack architecture diagram as of 2013-09-27" src="../../../images/architecture.png" /></p>
<pre><code class="highlight plaintext">Check Receivers ---&gt; Executive ---&gt; Gateways
</code></pre>

<p><strong>Check Receivers</strong> read check data generated by external programs; Flapjack ships with a Nagios checks receiver, and connectors to other sources of check data could also be written. Checks define the entity they refer to as being in one of three states (<code class="prettyprint">OK</code>, <code class="prettyprint">WARNING</code> or <code class="prettyprint">CRITICAL</code>), are timestamped and can optionally include further data about the reason for the current entity state. The checks are added onto an events queue by the check receivers.</p>

<p>The Flapjack <strong>Executive</strong> reads events from the events queue and determines which contacts should be notified for them. It runs filters to prevent notifications being fired too often for the same check.</p>

<p>Flapjack <strong>Gateways</strong> serve as the public interface to Flapjack. There are <em>unidirectional</em> notifiers (e.g. <code class="prettyprint">email</code> and <code class="prettyprint">sms</code>, which read notifications from a queue and send them out to registered contacts, there are <em>bidirectional</em> notifiers (e.g. <code class="prettyprint">jabber</code>, <code class="prettyprint">pagerduty</code>) which do the above and also offer a back-channel for acknowledgements etc., and there are also <code class="prettyprint">web</code> and <code class="prettyprint">api</code> gateways for retrieving reporting data, creating maintenance periods, acknowledging checks, etc.</p>
<h3 id='processor-and-notifier'>Processor and Notifier</h3>
<p>In the beginning, there was Executive. This has been split into two separte components, <em>processor</em> and <em>notifier</em>.</p>

<p>Flapjack processor processes events from the <em>events</em> list in redis. It does a blocking read on redis so new events are picked off the events list and processed as soon as they created.</p>

<p>When executive decides somebody ought to be notified (for a problem, recovery, or acknowledgement or what-have-you) it generates a job on the <em>notifications</em> queue.</p>

<p>Notifier picks up jobs from the <em>notificaitons</em> queue, looks up contact information, applies notification rules and per-media intervals and rollup logic, and then creates notification jobs for the appropriate notification gateways.</p>

<p><a id="components">&nbsp;</a></p>
<h2 id='components'>Components</h2>
<p>Executables:</p>

<ul>
<li><code class="prettyprint">flapjack</code> =&gt; starts multiple components (&lsquo;pikelets&rsquo;) within the one ruby process as specified in the configuration file.</li>
<li><code class="prettyprint">flapjack-nagios-receiver</code> =&gt; reads nagios check output on standard input and places them on the events queue in redis as JSON blobs. Currently unable to be run in-process with <code class="prettyprint">flapjack</code></li>
<li><code class="prettyprint">flapjack-nsca-receiver</code> =&gt; reads the nagios&#39; commandfile output and places them on the events queue in redis as JSON blobs. Currently unable to be run in-process with <code class="prettyprint">flapjack</code></li>
<li><code class="prettyprint">flapper</code> =&gt; runs a daemon that intermittently listens on port 12345 (one minute on, one minute off, &hellip;)
to be used for generating heartbeat events for end to end monitoring of flapjack</li>
<li><code class="prettyprint">flapjack-populator</code> =&gt; creates contacts and entities in redis, reading from JSON formatted data files</li>
<li><code class="prettyprint">receive-events</code> =&gt; reads archived events from a separate flapjack environment and adds them to the local events queue for processing</li>
<li><code class="prettyprint">simulate-failed-check</code> =&gt; simulates a failed check by creating a stream of events for flapjack to process</li>
</ul>

<p>Usage information for each executable is provided below.</p>

<p>Pikelets:</p>

<ul>
<li>  <code class="prettyprint">processor</code> =&gt; processes monitoring events off the <em>events</em> queue (a redis list) and decides what actions to take (generate notification event, record state changes, etc)</li>
<li><p><code class="prettyprint">notifier</code> =&gt; processes notification events off the <em>notifications</em> queue (a redis list) and works out who to notify, and on which media, and with what kind of notification message. It then creates jobs for the various notification gateways (below)</p></li>
<li><p>notification gateways</p>

<ul>
<li><code class="prettyprint">email</code> =&gt; generates email notifications (resque, mail)</li>
<li><code class="prettyprint">sms</code> =&gt; generates sms notifications (resque)</li>
<li><code class="prettyprint">jabber</code> =&gt; connects to an XMPP (jabber) server, sends notifications (to rooms and individuals), handles acknowledgements from jabber users and other commands (blather)</li>
<li><code class="prettyprint">pagerduty</code> =&gt; sends notifications to and accepts acknowledgements from <a href="http://www.pagerduty.com/">PagerDuty</a> (NB: contacts will need to have a registered PagerDuty account to use this)</li>
</ul></li>
<li><p>other gateways</p>

<ul>
<li><code class="prettyprint">web</code> =&gt; browsable web interface (sinatra, thin)</li>
<li><code class="prettyprint">api</code> =&gt; HTTP API server (sinatra, thin)</li>
<li><code class="prettyprint">oobetet</code> =&gt; &ldquo;out-of-band&rdquo; end-to-end testing, used for monitoring other instances of flapjack to ensure that they are running correctly</li>
</ul></li>
</ul>

<p>Pikelets are flapjack components which can be run within the same ruby process, or as separate processes.</p>

<p>The simplest configuration will have one <code class="prettyprint">flapjack</code> process running processor, notifier, web, and some notification gateways, and one <code class="prettyprint">flapjack-nagios-receiver</code> process receiving events from Nagios and placing them on the events queue for processing.</p>

<p><a id="configuring_components">&nbsp;</a></p>
<h2 id='configuring-components'>Configuring Components</h2>
<p>Copy the example config file into place:</p>
<pre><code class="highlight plaintext">cp etc/flapjack-config.yaml.example etc/flapjack-config.yaml
</code></pre>

<p>and then edit the configuration to suit. The value of the environment variable <code class="prettyprint">FLAPJACK_ENV</code> is used as the configuration key, to choose which of the top-level configuration hashes in the YAML file should be loaded. (The default FLAPJACK_ENV is &ldquo;development&rdquo; if there is no environment variable set.)</p>

<p>An example configuration stanza is replicated below, along with comments describing the function of the configuration settings.</p>
<pre><code class="highlight yaml"><span class="s">development</span><span class="pi">:</span>
  <span class="s">pid_file</span><span class="pi">:</span> <span class="s">tmp/pids/flapjack.pid</span>
  <span class="s">log_file</span><span class="pi">:</span> <span class="s">log/flapjack.log</span>
  <span class="c1"># whether or not flapjack should run daemonized (using the daemons gem)</span>
  <span class="s">daemonize</span><span class="pi">:</span> <span class="s">no</span>
  <span class="s">redis</span><span class="pi">:</span>
    <span class="c1"># the redis server hostname to connect to</span>
    <span class="s">host</span><span class="pi">:</span> <span class="s">127.0.0.1</span>
    <span class="c1"># the redis server port to connect to</span>
    <span class="s">port</span><span class="pi">:</span> <span class="s">6379</span>
    <span class="c1"># the redis database number to use</span>
    <span class="s">db</span><span class="pi">:</span> <span class="s">13</span>
  <span class="s">processor</span><span class="pi">:</span>
    <span class="s">enabled</span><span class="pi">:</span> <span class="s">yes</span>
    <span class="s">queue</span><span class="pi">:</span> <span class="s">events</span>
    <span class="s">notifier_queue</span><span class="pi">:</span> <span class="s">notifications</span>
    <span class="s">archive_events</span><span class="pi">:</span> <span class="s">true</span>
    <span class="s">events_archive_maxage</span><span class="pi">:</span> <span class="s">10800</span>
    <span class="s">new_check_scheduled_maintenance_duration</span><span class="pi">:</span> <span class="s">100 years</span>
    <span class="s">logger</span><span class="pi">:</span>
      <span class="s">level</span><span class="pi">:</span> <span class="s">INFO</span>
      <span class="s">syslog_errors</span><span class="pi">:</span> <span class="s">yes</span>
  <span class="s">notifier</span><span class="pi">:</span>
    <span class="s">enabled</span><span class="pi">:</span> <span class="s">yes</span>
    <span class="s">queue</span><span class="pi">:</span> <span class="s">notifications</span>
    <span class="s">email_queue</span><span class="pi">:</span> <span class="s">email_notifications</span>
    <span class="s">sms_queue</span><span class="pi">:</span> <span class="s">sms_notifications</span>
    <span class="s">jabber_queue</span><span class="pi">:</span> <span class="s">jabber_notifications</span>
    <span class="s">pagerduty_queue</span><span class="pi">:</span> <span class="s">pagerduty_notifications</span>
    <span class="s">notification_log_file</span><span class="pi">:</span> <span class="s">/var/log/flapjack/notification.log</span>
    <span class="s">default_contact_timezone</span><span class="pi">:</span> <span class="s">UTC</span>
    <span class="s">logger</span><span class="pi">:</span>
      <span class="s">level</span><span class="pi">:</span> <span class="s">INFO</span>
      <span class="s">syslog_errors</span><span class="pi">:</span> <span class="s">yes</span>
  <span class="s">nagios-receiver</span><span class="pi">:</span>
    <span class="s">fifo</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/var/cache/nagios3/event_stream.fifo"</span>
    <span class="s">pid_file</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/var/run/flapjack/flapjack-nagios-receiver.pid"</span>
    <span class="s">log_file</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/var/log/flapjack/flapjack-nagios-receiver.log"</span>
  <span class="s">nsca-receiver</span><span class="pi">:</span>
    <span class="s">fifo</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/var/lib/nagios3/rw/nagios.cmd"</span>
    <span class="s">pid_file</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/var/run/flapjack/flapjack-nsca-receiver.pid"</span>
    <span class="s">log_file</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/var/log/flapjack/flapjack-nsca-receiver.log"</span>
  <span class="s">gateways</span><span class="pi">:</span>
    <span class="s">email</span><span class="pi">:</span>
      <span class="c1"># whether or not this pikelet should be started</span>
      <span class="s">enabled</span><span class="pi">:</span> <span class="s">yes</span>
      <span class="c1"># the redis queue the pikelet will look for notifications on</span>
      <span class="s">queue</span><span class="pi">:</span> <span class="s">email_notifications</span>
      <span class="s">logger</span><span class="pi">:</span>
        <span class="s">level</span><span class="pi">:</span> <span class="s">INFO</span>
      <span class="s">smtp_config</span><span class="pi">:</span>
        <span class="c1"># these values are passed directly through to EventMachine::Protocols::SmtpClient configuration,</span>
        <span class="c1"># and can be omitted if the defaults are acceptable</span>
        <span class="s">host</span><span class="pi">:</span> <span class="s2">"</span><span class="s">localhost"</span>
        <span class="s">port</span><span class="pi">:</span> <span class="s">25</span>
        <span class="s">domain</span><span class="pi">:</span> <span class="s1">'</span><span class="s">localhost.localdomain'</span>
        <span class="s">starttls</span><span class="pi">:</span> <span class="s">false</span>
        <span class="s">from</span><span class="pi">:</span> <span class="s1">'</span><span class="s">flapjack@localhost.localdomain'</span>
        <span class="c1">#auth:</span>
        <span class="c1">#  type: :plain</span>
        <span class="c1">#  username: vera</span>
        <span class="c1">#  password: xxxxxxxx</span>
      <span class="c1"># location of custom alert templates</span>
      <span class="c1">#templates:</span>
      <span class="c1">#  rollup_subject.text: '/etc/flapjack/templates/email/rollup_subject.text.erb'</span>
      <span class="c1">#  alert_subject.text: '/etc/flapjack/templates/email/alert_subject.text.erb'</span>
      <span class="c1">#  rollup.text: '/etc/flapjack/templates/email/rollup.text.erb'</span>
      <span class="c1">#  alert.text: '/etc/flapjack/templates/email/alert.text.erb'</span>
      <span class="c1">#  rollup.html: '/etc/flapjack/templates/email/rollup.html.erb'</span>
      <span class="c1">#  alert.html: '/etc/flapjack/templates/email/alert.html.erb'</span>
    <span class="s">sms</span><span class="pi">:</span>
      <span class="c1"># whether or not this pikelet should be started</span>
      <span class="s">enabled</span><span class="pi">:</span> <span class="s">yes</span>
      <span class="c1"># the redis queue the pikelet will look for notifications on</span>
      <span class="s">queue</span><span class="pi">:</span> <span class="s">sms_notifications</span>
      <span class="s">username</span><span class="pi">:</span> <span class="s2">"</span><span class="s">ermahgerd"</span>
      <span class="s">password</span><span class="pi">:</span> <span class="s2">"</span><span class="s">xxxx"</span>
      <span class="s">logger</span><span class="pi">:</span>
        <span class="s">level</span><span class="pi">:</span> <span class="s">INFO</span>
      <span class="c1"># location of custom alert templates</span>
      <span class="c1">#templates:</span>
      <span class="c1">#  rollup.text: '/etc/flapjack/templates/sms/rollup.text.erb'</span>
      <span class="c1">#  alert.text: '/etc/flapjack/templates/sms/alert.text.erb'</span>
    <span class="s">jabber</span><span class="pi">:</span>
      <span class="c1"># whether or not this pikelet should be started</span>
      <span class="s">enabled</span><span class="pi">:</span> <span class="s">yes</span>
      <span class="c1"># the redis queue the pikelet will look for notifications on</span>
      <span class="s">queue</span><span class="pi">:</span> <span class="s">jabber_notifications</span>
      <span class="c1"># the jabber server hostname to connect to</span>
      <span class="s">server</span><span class="pi">:</span> <span class="s2">"</span><span class="s">jabber.domain.tld"</span>
      <span class="c1"># the jabber server port to connect to</span>
      <span class="s">port</span><span class="pi">:</span> <span class="s">5222</span>
      <span class="c1"># the jabber username to present for signing in</span>
      <span class="s">jabberid</span><span class="pi">:</span> <span class="s2">"</span><span class="s">flapjack@jabber.domain.tld"</span>
      <span class="c1"># the jabber password to present for signing in</span>
      <span class="s">password</span><span class="pi">:</span> <span class="s2">"</span><span class="s">good-password"</span>
      <span class="c1"># the user alias the pikelet should use</span>
      <span class="s">alias</span><span class="pi">:</span> <span class="s2">"</span><span class="s">flapjack"</span>
      <span class="c1"># the Multi-User Chats the pikelet should join and announce to</span>
      <span class="s">rooms</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s2">"</span><span class="s">flapjacktest@conference.jabber.domain.tld"</span>
        <span class="pi">-</span> <span class="s2">"</span><span class="s">log@conference.jabber.domain.tld"</span>
      <span class="s">logger</span><span class="pi">:</span>
        <span class="s">level</span><span class="pi">:</span> <span class="s">INFO</span>
      <span class="c1"># location of custom alert templates</span>
      <span class="c1">#templates:</span>
      <span class="c1">#  rollup.text: '/etc/flapjack/templates/jabber/rollup.text.erb'</span>
      <span class="c1">#  alert.text: '/etc/flapjack/templates/jabber/alert.text.erb'</span>
    <span class="s">oobetet</span><span class="pi">:</span>
      <span class="c1"># whether or not this pikelet should be started</span>
      <span class="s">enabled</span><span class="pi">:</span> <span class="s">yes</span>
      <span class="c1"># server, port, jabberid, password, alias, rooms: see the jabber pikelet</span>
      <span class="s">server</span><span class="pi">:</span> <span class="s2">"</span><span class="s">jabber.domain.tld"</span>
      <span class="s">port</span><span class="pi">:</span> <span class="s">5222</span>
      <span class="s">jabberid</span><span class="pi">:</span> <span class="s2">"</span><span class="s">flapjacktest@jabber.domain.tld"</span>
      <span class="s">password</span><span class="pi">:</span> <span class="s2">"</span><span class="s">nuther-good-password"</span>
      <span class="s">alias</span><span class="pi">:</span> <span class="s2">"</span><span class="s">flapjacktest"</span>
      <span class="s">watched_check</span><span class="pi">:</span> <span class="s2">"</span><span class="s">PING"</span>
      <span class="s">watched_entity</span><span class="pi">:</span> <span class="s2">"</span><span class="s">foo.bar.net"</span>
      <span class="s">max_latency</span><span class="pi">:</span> <span class="s">300</span>
      <span class="s">pagerduty_contact</span><span class="pi">:</span> <span class="s2">"</span><span class="s">11111111111111111111111111111111"</span>
      <span class="s">rooms</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s2">"</span><span class="s">flapjacktest@conference.jabber.domain.tld"</span>
        <span class="pi">-</span> <span class="s2">"</span><span class="s">log@conference.jabber.domain.tld"</span>
      <span class="s">logger</span><span class="pi">:</span>
        <span class="s">level</span><span class="pi">:</span> <span class="s">INFO</span>
    <span class="s">pagerduty</span><span class="pi">:</span>
      <span class="c1"># whether or not this pikelet should be started</span>
      <span class="s">enabled</span><span class="pi">:</span> <span class="s">yes</span>
      <span class="c1"># the redis queue the pikelet will look for notifications on</span>
      <span class="s">queue</span><span class="pi">:</span> <span class="s">pagerduty_notifications</span>
      <span class="s">logger</span><span class="pi">:</span>
        <span class="s">level</span><span class="pi">:</span> <span class="s">INFO</span>
      <span class="c1"># location of custom alert templates</span>
      <span class="c1">#templates:</span>
      <span class="c1">#  alert.text: '/etc/flapjack/templates/pagerduty/alert.text.erb'</span>
    <span class="s">web</span><span class="pi">:</span>
      <span class="c1"># whether or not this pikelet should be started</span>
      <span class="s">enabled</span><span class="pi">:</span> <span class="s">yes</span>
      <span class="c1"># the port the web server should be run on</span>
      <span class="s">port</span><span class="pi">:</span> <span class="s">5080</span>
      <span class="s">logger</span><span class="pi">:</span>
        <span class="s">level</span><span class="pi">:</span> <span class="s">INFO</span>
    <span class="s">api</span><span class="pi">:</span>
      <span class="c1"># whether or not this pikelet should be started</span>
      <span class="s">enabled</span><span class="pi">:</span> <span class="s">yes</span>
      <span class="c1"># the port the API server should be run on</span>
      <span class="s">port</span><span class="pi">:</span> <span class="s">5081</span>
      <span class="s">logger</span><span class="pi">:</span>
        <span class="s">level</span><span class="pi">:</span> <span class="s">INFO</span>
</code></pre>
<h4 id='details'>Details</h4><h5 id='processor-code-classprettyprintnew_check_scheduled_maintenance_durationcode'>processor: <code class="prettyprint">new_check_scheduled_maintenance_duration</code></h5>
<p>This setting controls how long we set scheduled maintenance for new check results.</p>

<p>Flapjack sets scheduled maintenance on new check results so contacts aren&rsquo;t notified as soon as Flapjack becomes aware of an entity to notify on. This is useful is cases where your monitoring starts checking something before it is completely provisioned,</p>

<p>For example:</p>

<blockquote>
<p>CloudFormation starts a cluster of EC2 instances that take 10 minutes to provision, but your monitoring starts checking those EC2 instances 5 minutes into their provisioning. This would result in false-positives from Flapjack, as Flapjack would notify contacts before the instances are fully provisioned.</p>
</blockquote>

<p>The value for this setting is parsed by <a href="https://github.com/hpoydar/chronic_duration">Chronic Duration</a>, so you can specify interesting things like:</p>

<ul>
<li><code class="prettyprint">12.4 secs</code></li>
<li><code class="prettyprint">1:20</code> =&gt; 1 minute 20 seconds</li>
<li><code class="prettyprint">6 mos 1 day</code> =&gt; 6 months 1 day</li>
<li><code class="prettyprint">47 yrs 6 mos and 4d</code></li>
<li><code class="prettyprint">two hours and twenty minutes</code></li>
</ul>

<p>You can disable this setting by specifying <code class="prettyprint">0 seconds</code>.</p>

<p>The default value for this setting is <code class="prettyprint">100 years</code>.</p>

<p><a id="configuring_nagios">&nbsp;</a></p>
<h3 id='configuring-nagios'>Configuring Nagios</h3>
<p>You need a Nagios prior to version 3.3 as it introduced <a href="http://tracker.nagios.org/view.php?id=247">a bug that breaks perfdata output</a> for checks which don&rsquo;t generate performance data (stuff after a | in the check output).</p>

<p>Because this output is omitted, <code class="prettyprint">flapjack-nagios-receiver</code> is unable to parse event information from Nagios and send it to Flapjack.</p>

<p>There are unconfirmed reports Nagios releases in the 3.4.x series have a fix for the perfdata, however we have not confirmed this. Nagios 4.x <em>may</em> also work, however this is also unconfirmed.</p>

<p>We are developing and running against Nagios version 3.2.3 with success.</p>

<p><code class="prettyprint">nagios.cfg</code> config file changes:</p>
<pre><code class="highlight plaintext"># modified lines:
enable_notifications=0
host_perfdata_file=/var/cache/nagios3/event_stream.fifo
service_perfdata_file=/var/cache/nagios3/event_stream.fifo
host_perfdata_file_template=[HOSTPERFDATA]\t$TIMET$\t$HOSTNAME$\tHOST\t$HOSTSTATE$\t$HOSTEXECUTIONTIME$\t$HOSTLATENCY$\t$HOSTOUTPUT$\t$HOSTPERFDATA$
service_perfdata_file_template=[SERVICEPERFDATA]\t$TIMET$\t$HOSTNAME$\t$SERVICEDESC$\t$SERVICESTATE$\t$SERVICEEXECUTIONTIME$\t$SERVICELATENCY$\t$SERVICEOUTPUT$\t$SERVICEPERFDATA$
host_perfdata_file_mode=p
service_perfdata_file_mode=p
</code></pre>

<p>What we&rsquo;re doing here is telling Nagios to generate a line of output for every host and service check into a named pipe. The template lines must be as above so that <code class="prettyprint">flapjack-nagios-receiver</code> knows what to expect.</p>

<p>All hosts and services (or templates that they use) will need to have process_perf_data enabled on them. (This is a real misnomer, it doesn&rsquo;t mean the performance data will be processed, just that it will be fed to the perfdata output channel, a named pipe in our case.)</p>

<p>Create the named pipe if it doesn&rsquo;t already exist:</p>
<pre><code class="highlight plaintext">mkfifo -m 0666 /var/cache/nagios3/event_stream.fifo
</code></pre>

<p>Note that the templates used in the nagios configuration for service_perfdata_file_template and host_perfdata_file_template must be configured to be exactly as flapjack-nagios-receiver expects otherwise it will drop events that don&rsquo;t match the expected format. The current requrements for the data format that flapjack-nagios-receiver expects from the named pipe is as per the above nagios templates. The following checks are made of each line of textual data found in the pipe, and if any fail the line does not result in an event being created:</p>

<p>The line must:
- split into at least 9 tab-separated words
- contain a unix timestamp in the 2nd word (seconds since epoch) - so just a whole number
- the first word (object type) must contain either <code class="prettyprint">[HOSTPERFDATA]</code> or <code class="prettyprint">[SERVICEPERFDATA]</code>.</p>

<p>Currently any error messages about lines that are unable to be read are written to STDOUT.</p>
<h4 id='limitations-with-the-flapjack-nagios-receiver-approach'>Limitations with the flapjack-nagios-receiver approach</h4>
<p>We have seen loss of events with this event transport when the number of events being generated between dumps to the named pipe goes above some threshold. It would appear as though Nagios is overflowing an internal buffer for the performance data between each 10 or 20 second perfdata output flush. This was of the order of thousands of events per flush. It could also have been some other aspect of this transport causing events to be lost.</p>

<p>For this reason, a nagios event broker module - <a href="https://github.com/flapjack/flapjackfeeder">flapjackfeeder</a> - is being developed to offer an alternative to flapjack-nagios-receiver for high check throughput environments, or potentially a full replacement.</p>

<p><a id="running">&nbsp;</a></p>
<h2 id='running'>Running</h2>
<p>There&rsquo;s a collection of executables included. Here&rsquo;s their usage information.</p>
<h3 id='flapjack'>flapjack</h3><pre><code class="highlight plaintext">Usage: flapjack COMMAND [OPTIONS]

Commands
     start                           start flapjack
     stop                            stop flapjack
     restart                         (re)start flapjack
     reload                          reload flapjack configuration
     status                          see if flapjack is running
     version                         display flapjack version and exit
     help                            display this usage info

Options
    -c, --config [PATH]              PATH to the config file to use
    -d, --[no-]daemonize             Daemonize?
    -p, --pidfile [PATH]             PATH to the pidfile to write to
    -l, --logfile [PATH]             PATH to the logfile to write to
    -v, --version                    display flapjack version
</code></pre>
<h3 id='flapjack-nagios-receiver'>flapjack-nagios-receiver</h3><pre><code class="highlight plaintext">Usage: flapjack-nagios-receiver COMMAND [OPTIONS]

Commands
     start                           start flapjack-nagios-receiver
     stop                            stop flapjack-nagios-receiver
     restart                         (re)start flapjack-nagios-receiver
     status                          see if flapjack-nagios-receiver is running

Options
    -c, --config [PATH]              PATH to the config file to use
    -f, --fifo FIFO                  Path to the nagios perfdata named pipe
    -d, --[no-]daemonize             Daemonize?
    -p, --pidfile [PATH]             PATH to the pidfile to write to
    -l, --logfile [PATH]             PATH to the logfile to write to
    -h, --help                       Show this usage message
</code></pre>
<h2 id='required-nagios-configuration-changes'>Required Nagios Configuration Changes</h2>
<p>flapjack-nagios-receiver reads events from a named pipe written to by Nagios..                                                              The named pipe needs creating, and Nagios needs to be told to write performance.
data output to it.</p>

<p>To create the named pipe:</p>
<pre><code class="highlight plaintext">mkfifo -m 0666 /var/cache/nagios3/event_stream.fifo
</code></pre>

<p>nagios.cfg changes:</p>
<pre><code class="highlight plaintext">  # modified lines:
  enable_notifications=0
  host_perfdata_file=/var/cache/nagios3/event_stream.fifo
  service_perfdata_file=/var/cache/nagios3/event_stream.fifo
  host_perfdata_file_template=[HOSTPERFDATA]\t$TIMET$\t$HOSTNAME$\tHOST\t$HOSTSTATE$\t$HOSTEXECUTIONTIME$\t$HOSTLATENCY$\t$HOSTOUTPUT$\t$HOSTPERFDATA$
  service_perfdata_file_template=[SERVICEPERFDATA]\t$TIMET$\t$HOSTNAME$\t$SERVICEDESC$\t$SERVICESTATE$\t$SERVICEEXECUTIONTIME$\t$SERVICELATENCY$\t$SERVICEOUTPUT$\t$SERVICEPERFDATA$
  host_perfdata_file_mode=p
  service_perfdata_file_mode=p
</code></pre>

<p>Details on the <a href="#configuring_nagios">wiki</a></p>

<p>Examples:</p>
<pre><code class="highlight shell">flapjack-nagios-receiver start --config /etc/flapjack/flapjack-config.yaml --fifo /path/to/nagios/perfdata.fifo
flapjack-nagios-receiver status
flapjack-nagios-receiver restart --config /etc/flapjack/flapjack-config.yaml --fifo /path/to/nagios/perfdata.fifo
flapjack-nagios-receiver stop
</code></pre>

<p>The redis database connection information is read out of the specified flapjack configuration file, for the current FLAPJACK_ENV environment.</p>

<p>See the <a href="#configuring_nagios">Configuring Nagios</a> section above for more information.</p>
<h3 id='flapper'>flapper</h3><pre><code class="highlight plaintext">Usage: flapper COMMAND [OPTIONS]

Commands
     start                           start flapper
     stop                            stop flapper
     restart                         (re)start flapper
     status                          see if flapper is running

Options
    -d, --[no-]daemonize             Daemonize?
    -p, --pidfile [PATH]             PATH to the pidfile to write to
    -l, --logfile [PATH]             PATH to the logfile to write to
    -b, --bind-ip [ADDRESS]          ADDRESS (IPv4 or IPv6) for flapper to bind to
</code></pre>
<h3 id='flapjack-populator'>flapjack-populator</h3><pre><code class="highlight plaintext">Usage: flapjack-populator COMMAND [OPTIONS]

Commands:
     import-entities
     import-contacts
     purge-events    purge queued monitoring events

Options
    -c, --config [PATH]              PATH to the config file to use
    -f, --from [FILE]                path to the FILE to import
</code></pre>
<h3 id='receive-events'>receive-events</h3><pre><code class="highlight plaintext">Usage: receive-events COMMAND [OPTIONS]

Commands
     help

Options
    -c, --config [PATH]              PATH to the config file to use
    -s, --source URL                 URL of source redis database, eg redis://localhost:6379/0
    -f, --follow                     keep reading events as they are archived on the source
    -a, --all                        replay all archived events from the source
    -l, --last COUNT                 replay the last COUNT events from the source
    -t, --time TIME                  replay all events archived on the source since TIME
</code></pre>
<h3 id='simulate-failed-check'>simulate-failed-check</h3><pre><code class="highlight plaintext">Usage: simulate-failed-check COMMAND [OPTIONS]

Commands
     fail-and-recover
     fail

Options
    -c, --config [PATH]              PATH to the config file to use
    -t, --time MINUTES               MINUTES to generate failure events for
    -i, --interval SECONDS           SECONDS between events, can be decimal eg 0.1 (10)
    -e, --entity ENTITY              ENTITY to generate failure events for ('foo-app-01')
    -k, --check CHECK                CHECK to generate failure events for ('HTTP')
    -s, --state STATE                optional STATE to generate failure events with ('CRITICAL')
</code></pre>

<p><a id="resque">&nbsp;</a></p>
<h2 id='resque'>Resque</h2><h3 id='resque-workers'>Resque Workers</h3>
<p>We&rsquo;re using <a href="https://github.com/resque/resque">Resque</a> to queue email and sms notifications generated by flapjack-executive. The queues are named as follows:
- email_notifications
- sms_notifications</p>

<p>Note that using the flapjack-config.yaml file you can have flapjack start the resque workers in-process. Or you can run them standalone with the <code class="prettyprint">rake resque:work</code> command as follows.</p>

<p>One resque worker that processes both queues (but prioritises SMS above email) can be started as follows:</p>
<pre><code class="highlight plaintext">QUEUE=sms_notifications,email_notifications VERBOSE=1 be rake resque:work
</code></pre>

<p>resque sets the command name so grep&#39;ing ps output for <code class="prettyprint">rake</code> or <code class="prettyprint">ruby</code> will NOT find resque processes. Search instead for <code class="prettyprint">resque</code>. (and remember the &lsquo;q&rsquo;).</p>

<p>To background it you can add <code class="prettyprint">BACKGROUND=yes</code>. Useful documentation is available in <a href="https://github.com/resque/resque/blob/master/README.md">Resque&rsquo;s README</a></p>
<h3 id='resque-queue-management-with-resque-web'>Resque Queue Management with resque-web</h3>
<p>If you need to inspect or purge the queues managed by resque you&rsquo;ll want to start up an instance of resque-web. This will by default connect to redis database 0 which is fine for production but in development you&rsquo;ll need to specify database id 13 (or whatever you have it set to in the flapjack config) eg:</p>
<pre><code class="highlight shell">resque-web -p 4082 -r localhost:6379:13
</code></pre>

<p>This will start a resque-web instance listening on port 4082, connecting to the redis server on localhost port 6379, and selecting database 13.</p>

<p><a id="redis_database_instances">&nbsp;</a></p>
<h2 id='redis-database-instances'>Redis Database Instances</h2>
<p>We use the following redis database numbers by convention:</p>

<ul>
<li>0 =&gt; production</li>
<li>6 =&gt; quickstart</li>
<li>13 =&gt; development</li>
<li>14 =&gt; testing</li>
</ul>

      </div>
    </div>
  </div> <!-- container -->

  <footer>
<div class="row">
<div class="col-md-4 col-md-offset-2">
  Flapjack was conceptualised by
  <a href="https://twitter.com/auxesis">Lindsay Holmwood</a>.
  <a href="https://twitter.com/jessereynolds">Jesse Reynolds</a> and
  <a href="https://github.com/ali-graham">Ali Graham</a>
  are the primary developers.
  View the project on <a href="https://github.com/flapjack/flapjack">GitHub</a>.
</div>
<div class="col-md-4 sponsor">
  <a href="http://bulletproof.net.au" target="_bulletproof">
    <img class="bulletproof" src="/images/bulletproof-logo.png"/>
  </a>
  <span class="bulletproof subtext">
    Development sponsored by
    <a href="http://bulletproof.net.au" target="_bulletproof">Bulletproof</a>.
  </span>
</div>
</div>
</footer>

<script type="text/javascript">
  var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
  document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
  try {
    var pageTracker = _gat._getTracker("UA-388962-5");
    pageTracker._trackPageview();
  } catch(err) {}
</script>

</body>
</html>
