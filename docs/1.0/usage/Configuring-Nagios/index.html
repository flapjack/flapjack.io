<!DOCTYPE html>
<html lang="en">
    <head>
  <title>Flapjack, monitoring notification routing + event processing</title>
  <link rel='stylesheet' href='/stylesheets/bootstrap.min.css'/>
  <link rel="stylesheet" href="/stylesheets/api-screen.css" type="text/css" media="screen" />
  <link rel="stylesheet" href="/stylesheets/api-syntax.css" type="text/css" media="screen" />
  <link rel="shortcut icon" href="/images/flapjack-2013-favicon-64-32-24-16.ico" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
  <nav class="navbar navbar-default navbar-inverse" role="navigation" style="margin-bottom: 0px">
    <div class="navbar-header">
      <a class="navbar-brand" href="/">
        <img class="logo" src="/images/flapjack-2013-notext-transparent-300-300.png"/>
        <span class="name">Flapjack</span>
      </a>
    </div>
    <div class="collapse navbar-collapse navbar-ex1-collapse">
      <ul class="nav navbar-nav navbar-right">
        <li><a href="/docs/1.0/usage/quickstart">Quickstart</a></li>
        <li><a href="/docs">Documentation</a></li>
        <li><a href="/support">Support</a></li>
      </ul>
    </div>
  </nav>

    <center>
      
    </center>
    <div class="container content">
      <div class="row">
        <div class="col-md-offset-1 col-md-10">
        <h1 id="configuring-nagios">Configuring Nagios</h1>

<p>Nagios versions 3.3 - 3.4.2 will not work due to <a href="http://tracker.nagios.org/view.php?id=247">a bug that breaks perfdata output</a> for checks which don&rsquo;t generate performance data (text after a | in the check output).</p>

<p>Because this output is omitted, <code class="prettyprint">flapjack receiver nagios</code> is unable to parse event information from Nagios and send it to Flapjack.</p>

<p>This has been fixed in Nagios 3.4.2.  Nagios 4.x <em>may</em> also work, however this is unconfirmed.</p>

<p>We are developing and running against Nagios version 3.2.3 with success.</p>

<p>There are two ways to configure nagios.</p>

<h2 id="flapjack&#39;s-broker-module">Flapjack&rsquo;s broker module</h2>

<p>The first (and recommended) way is to enable the flapjackfeeder.o broker module.</p>

<p><code class="prettyprint">nagios.cfg</code> config file changes:</p>
<pre class="highlight plaintext"># modified lines:
enable_notifications=0
broker_module=/usr/local/lib/flapjackfeeder.o redis_host=localhost,redis_port=6380
</pre>

<h2 id="flapjack&#39;s-receiver-command">Flapjack&rsquo;s receiver command</h2>

<p>Note: We have seen loss of events with this event transport when the number of events being generated between dumps to the named pipe goes above some threshold. It would appear as though Nagios is overflowing an internal buffer for the performance data between each 10 or 20 second perfdata output flush. This was of the order of thousands of events per flush. It could also have been some other aspect of this transport causing events to be lost.  For this reason, the nagios event broker module above was created, and is now the recommended configuration.</p>

<p><code class="prettyprint">nagios.cfg</code> config file changes:</p>
<pre class="highlight plaintext"># modified lines:
enable_notifications=0
host_perfdata_file=/var/cache/nagios3/event_stream.fifo
service_perfdata_file=/var/cache/nagios3/event_stream.fifo
host_perfdata_file_template=[HOSTPERFDATA]\t$TIMET$\t$HOSTNAME$\tHOST\t$HOSTSTATE$\t$HOSTEXECUTIONTIME$\t$HOSTLATENCY$\t$HOSTOUTPUT$\t$HOSTPERFDATA$
service_perfdata_file_template=[SERVICEPERFDATA]\t$TIMET$\t$HOSTNAME$\t$SERVICEDESC$\t$SERVICESTATE$\t$SERVICEEXECUTIONTIME$\t$SERVICELATENCY$\t$SERVICEOUTPUT$\t$SERVICEPERFDATA$
host_perfdata_file_mode=p
service_perfdata_file_mode=p
</pre>

<p>What we&rsquo;re doing here is telling Nagios to generate a line of output for every host and service check into a named pipe. The template lines must be as above so that <code class="prettyprint">flapjack receiver nagios</code> knows what to expect.</p>

<p>All hosts and services (or templates that they use) will need to have process_perf_data enabled on them. (This is a real misnomer, it doesn&rsquo;t mean the performance data will be processed, just that it will be fed to the perfdata output channel, a named pipe in our case.)</p>

<p>Create the named pipe if it doesn&rsquo;t already exist:</p>
<pre class="highlight plaintext">mkfifo -m 0666 /var/cache/nagios3/event_stream.fifo
</pre>

<p>Note that the templates used in the nagios configuration for service_perfdata_file_template and host_perfdata_file_template must be configured to be exactly as flapjack-nagios-receiver expects otherwise it will drop events that don&rsquo;t match the expected format. The current requirements for the data format that flapjack-nagios-receiver expects from the named pipe is as per the above nagios templates. The following checks are made of each line of textual data found in the pipe, and if any fail the line does not result in an event being created:</p>

<p>The line must:
- split into at least 9 tab-separated words
- contain a unix timestamp in the 2nd word (seconds since epoch) - so just a whole number
- the first word (object type) must contain either <code class="prettyprint">[HOSTPERFDATA]</code> or <code class="prettyprint">[SERVICEPERFDATA]</code>.</p>

<p>Currently any error messages about lines that are unable to be read are written to STDOUT.</p>

      </div>
    </div>
  </div> <!-- container -->

  <footer>
<div class="row">
<div class="col-md-4 col-md-offset-2">
  Flapjack was conceptualised by
  <a href="https://twitter.com/auxesis">Lindsay Holmwood</a>.
  <a href="https://twitter.com/jessereynolds">Jesse Reynolds</a> and
  <a href="https://github.com/ali-graham">Ali Graham</a>
  are the primary developers.
  View the project on <a href="https://github.com/flapjack/flapjack">GitHub</a>.
</div>
<div class="col-md-4 sponsor">
  <a href="http://bulletproof.net.au" target="_bulletproof">
    <img class="bulletproof" src='/images/bulletproof-logo.png'/>
  </a>
  <span class="bulletproof subtext">
    Development sponsored by
    <a href="http://bulletproof.net.au" target="_bulletproof">Bulletproof</a>.
  </span>
</div>
</div>
</footer>

<script type="text/javascript">
  var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
  document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
  try {
    var pageTracker = _gat._getTracker("UA-388962-5");
    pageTracker._trackPageview();
  } catch(err) {}
</script>

</body>
</html>
