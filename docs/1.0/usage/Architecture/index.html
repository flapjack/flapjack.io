<!DOCTYPE html>
<html lang="en">
    <head>
  <title>Flapjack, monitoring notification routing + event processing</title>
  <link rel="stylesheet" href="/stylesheets/bootstrap.min.css"/>
  <link rel="stylesheet" href="/stylesheets/api-screen.css" type="text/css" media="screen" />
  <link rel="stylesheet" href="/stylesheets/api-syntax.css" type="text/css" media="screen" />
  <link rel="stylesheet" href="/stylesheets/github-markdown.css" type="text/css">
  <link rel="shortcut icon" href="/images/flapjack-2013-favicon-64-32-24-16.ico" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    .markdown-body {
        min-width: 200px;
        max-width: 790px;
        margin: 0 auto;
        padding: 30px;
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-default navbar-inverse" role="navigation" style="margin-bottom: 0px">
    <div class="navbar-header">
      <a class="navbar-brand" href="/">
        <img class="logo" src="/images/flapjack-2013-notext-transparent-300-300.png"/>
        <span class="name">Flapjack</span>
      </a>
    </div>
    <div class="collapse navbar-collapse navbar-ex1-collapse">
      <ul class="nav navbar-nav navbar-right">
        <li><a href="/docs/1.0/usage/quickstart">Quickstart</a></li>
        <li><a href="/docs">Documentation</a></li>
        <li><a href="/support">Support</a></li>
      </ul>
    </div>
  </nav>

    <center>
      
    </center>
    <div class="container content">
      <div class="row">
        <div class="col-md-offset-1 col-md-10 markdown-body">
        <h2 id="contents">Contents</h2>

<ul>
<li><a href="#architecture">Architecture</a></li>
<li><a href="#components">Components</a></li>
<li><a href="#resque">Resque</a></li>
<li><a href="#redis_database_instances">Redis Database Instances</a></li>
</ul>

<p><a id="architecture">&nbsp;</a></p>

<h2 id="architecture">Architecture</h2>

<p><img alt="Flapjack architecture diagram as of 2013-09-27" src="../../../../images/architecture.png" /></p>
<pre class="highlight plaintext">Check Receivers ---&gt; Executive ---&gt; Gateways
</pre>

<p><strong>Check Receivers</strong> read check data generated by external programs; Flapjack ships with a Nagios checks receiver, and connectors to other sources of check data could also be written. Checks define the entity they refer to as being in one of three states (<code class="prettyprint">OK</code>, <code class="prettyprint">WARNING</code> or <code class="prettyprint">CRITICAL</code>), are timestamped and can optionally include further data about the reason for the current entity state. The checks are added onto an events queue by the check receivers.</p>

<p>The Flapjack <strong>Executive</strong> reads events from the events queue and determines which contacts should be notified for them. It runs filters to prevent notifications being fired too often for the same check.</p>

<p>Flapjack <strong>Gateways</strong> serve as the public interface to Flapjack. There are <em>unidirectional</em> notifiers (e.g. <code class="prettyprint">email</code> and <code class="prettyprint">sms</code>, which read notifications from a queue and send them out to registered contacts, there are <em>bidirectional</em> notifiers (e.g. <code class="prettyprint">jabber</code>, <code class="prettyprint">pagerduty</code>) which do the above and also offer a back-channel for acknowledgements etc., and there are also <code class="prettyprint">web</code> and <code class="prettyprint">api</code> gateways for retrieving reporting data, creating maintenance periods, acknowledging checks, etc.</p>

<h3 id="processor-and-notifier">Processor and Notifier</h3>

<p>In the beginning, there was Executive. This has been split into two separate components, <em>processor</em> and <em>notifier</em>.</p>

<p>Flapjack processor processes events from the <em>events</em> list in redis. It does a blocking read on redis so new events are picked off the events list and processed as soon as they created.</p>

<p>When executive decides somebody ought to be notified (for a problem, recovery, or acknowledgement or what-have-you) it generates a job on the <em>notifications</em> queue.</p>

<p>Notifier picks up jobs from the <em>notifications</em> queue, looks up contact information, applies notification rules and per-media intervals and rollup logic, and then creates notification jobs for the appropriate notification gateways.</p>

<p><a id="components">&nbsp;</a></p>

<h2 id="components">Components</h2>

<p>Executables:</p>

<ul>
<li><code class="prettyprint">flapjack</code> =&gt; starts multiple components (&lsquo;pikelets&rsquo;) within the one ruby process as specified in the configuration file.</li>
<li><code class="prettyprint">flapjack receiver nagios</code> =&gt; reads nagios check output on standard input and places them on the events queue in redis as JSON blobs.</li>
<li><code class="prettyprint">flapjack receiver nsca</code> =&gt; reads the nagios&#39; commandfile output and places them on the events queue in redis as JSON blobs.</li>
<li><code class="prettyprint">flapjack flapper</code> =&gt; runs a daemon that intermittently listens on port 12345 (one minute on, one minute off, &hellip;)
to be used for generating heartbeat events for end to end monitoring of flapjack</li>
<li><code class="prettyprint">flapjack import</code> =&gt; creates contacts and entities in redis, reading from JSON formatted data files</li>
<li><code class="prettyprint">flapjack simulate fail</code> =&gt; simulates a failed check by creating a stream of events for flapjack to process</li>
</ul>

<p>Usage information for each executable is provided below.</p>

<p>Pikelets:</p>

<ul>
<li>  <code class="prettyprint">processor</code> =&gt; processes monitoring events off the <em>events</em> queue (a redis list) and decides what actions to take (generate notification event, record state changes, etc)</li>
<li><p><code class="prettyprint">notifier</code> =&gt; processes notification events off the <em>notifications</em> queue (a redis list) and works out who to notify, and on which media, and with what kind of notification message. It then creates jobs for the various notification gateways (below)</p></li>
<li><p>notification gateways</p>

<ul>
<li><code class="prettyprint">email</code> =&gt; generates email notifications (resque, mail)</li>
<li><code class="prettyprint">sms</code> =&gt; generates sms notifications (resque)</li>
<li><code class="prettyprint">jabber</code> =&gt; connects to an XMPP (jabber) server, sends notifications (to rooms and individuals), handles acknowledgements from jabber users and other commands (blather)</li>
<li><code class="prettyprint">pagerduty</code> =&gt; sends notifications to and accepts acknowledgements from <a href="http://www.pagerduty.com/">PagerDuty</a> (NB: contacts will need to have a registered PagerDuty account to use this)</li>
</ul></li>
<li><p>other gateways</p>

<ul>
<li><code class="prettyprint">web</code> =&gt; browsable web interface (sinatra, thin)</li>
<li><code class="prettyprint">jsonapi</code> =&gt; HTTP API server (sinatra, thin)</li>
<li><code class="prettyprint">oobetet</code> =&gt; &ldquo;out-of-band&rdquo; end-to-end testing, used for monitoring other instances of flapjack to ensure that they are running correctly</li>
</ul></li>
</ul>

<p>Pikelets are flapjack components which can be run within the same ruby process, or as separate processes.</p>

<p>The simplest configuration will have one <code class="prettyprint">flapjack</code> process running processor, notifier, web, and some notification gateways.  The same process will also run the receiver, which receives events from Nagios and places them on the events queue for processing.</p>

<p><a id="resque">&nbsp;</a></p>

<h2 id="resque">Resque</h2>

<h3 id="resque-workers">Resque Workers</h3>

<p>We&rsquo;re using <a href="https://github.com/resque/resque">Resque</a> to queue email and sms notifications generated by flapjack-executive. The queues are named as follows:
- email_notifications
- sms_notifications</p>

<p>Note that using the flapjack_config.yaml file you can have flapjack start the resque workers in-process. Or you can run them standalone with the <code class="prettyprint">rake resque:work</code> command as follows.</p>

<p>One resque worker that processes both queues (but prioritises SMS above email) can be started as follows:</p>
<pre class="highlight plaintext">QUEUE=sms_notifications,email_notifications VERBOSE=1 be rake resque:work
</pre>

<p>resque sets the command name so grep&#39;ing ps output for <code class="prettyprint">rake</code> or <code class="prettyprint">ruby</code> will NOT find resque processes. Search instead for <code class="prettyprint">resque</code>. (and remember the &lsquo;q&rsquo;).</p>

<p>To background it you can add <code class="prettyprint">BACKGROUND=yes</code>. Useful documentation is available in <a href="https://github.com/resque/resque/blob/master/README.md">Resque&rsquo;s README</a></p>

<h3 id="resque-queue-management-with-resque-web">Resque Queue Management with resque-web</h3>

<p>If you need to inspect or purge the queues managed by resque you&rsquo;ll want to start up an instance of resque-web. This will by default connect to redis database 0 which is fine for production but in development you&rsquo;ll need to specify database id 13 (or whatever you have it set to in the flapjack config) e.g.:</p>
<pre class="highlight shell">resque-web -p 4082 -r localhost:6379:13
</pre>

<p>This will start a resque-web instance listening on port 4082, connecting to the redis server on localhost port 6379, and selecting database 13.</p>

<p><a id="redis_database_instances">&nbsp;</a></p>

<h2 id="redis-database-instances">Redis Database Instances</h2>

<p>We use the following redis database numbers by convention:</p>

<ul>
<li>0 =&gt; production</li>
<li>6 =&gt; quickstart</li>
<li>13 =&gt; development</li>
<li>14 =&gt; testing</li>
</ul>

      </div>
    </div>
  </div> <!-- container -->

  <footer>
<div class="row">
<div class="col-md-4 col-md-offset-2">
  Flapjack was conceptualised by
  <a href="https://twitter.com/auxesis">Lindsay Holmwood</a>.
  <a href="https://twitter.com/jessereynolds">Jesse Reynolds</a> and
  <a href="https://github.com/ali-graham">Ali Graham</a>
  are the primary developers.
  View the project on <a href="https://github.com/flapjack/flapjack">GitHub</a>.
</div>
<div class="col-md-4 sponsor">
  <a href="http://bulletproof.net.au" target="_bulletproof">
    <img class="bulletproof" src="/images/bulletproof-logo.png"/>
  </a>
  <span class="bulletproof subtext">
    Development sponsored by
    <a href="http://bulletproof.net.au" target="_bulletproof">Bulletproof</a>.
  </span>
</div>
</div>
</footer>

<script type="text/javascript">
  var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
  document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
  try {
    var pageTracker = _gat._getTracker("UA-388962-5");
    pageTracker._trackPageview();
  } catch(err) {}
</script>

</body>
</html>
